<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1240px" preserveAspectRatio="none" style="width:767px;height:1240px;background:#FFFFFF;" version="1.1" viewBox="0 0 767 1240" width="767px" zoomAndPan="magnify"><defs><filter height="300%" id="f9f1yyur7i8nb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="304" x="228.25" y="28.708">JWT Authority sequence diagram</text><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="107.0078" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="170.6797"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="143.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="454.4844"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="171.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="706.4141"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="98.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="375" y="743.5469"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="171.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="950.3438"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="40.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="375" y="987.4766"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="330.9531"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="36.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="389.2188"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="483.6172"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="691.5" y="777.6797"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="691.5" y="1063.7422"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="291.9375" style="stroke:#000000;stroke-width:2.0;" width="637.5" x="10" y="228.8125"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="104.5313" style="stroke:#000000;stroke-width:2.0;" width="617.5" x="20" y="292.6875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="106" x2="106" y1="139.5469" y2="1140.0078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="374.5" x2="374.5" y1="139.5469" y2="1140.0078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="558.5" x2="558.5" y1="139.5469" y2="1140.0078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="696.5" x2="696.5" y1="139.5469" y2="1140.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="87.5" y="119.9482">User</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="146" x="30" y="136.2451">actually the browser</text><ellipse cx="106" cy="49.9531" fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M106,57.9531 L106,84.9531 M93,65.9531 L119,65.9531 M106,84.9531 L93,99.9531 M106,84.9531 L119,99.9531 " fill="none" filter="url(#f9f1yyur7i8nb)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="87.5" y="1152.0029">User</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="146" x="30" y="1168.2998">actually the browser</text><ellipse cx="106" cy="1181.6016" fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M106,1189.6016 L106,1216.6016 M93,1197.6016 L119,1197.6016 M106,1216.6016 L93,1231.6016 M106,1216.6016 L119,1231.6016 " fill="none" filter="url(#f9f1yyur7i8nb)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="101" x="322.5" y="104.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="329.5" y="124.2451">Coffee Chat</text><rect fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="101" x="322.5" y="1139.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="329.5" y="1159.0029">Coffee Chat</text><rect fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" height="62.8906" style="stroke:#A80036;stroke-width:1.5;" width="133" x="490.5" y="71.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="497.5" y="91.6514">OpenId-Connect</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="523" y="107.9482">Authority</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="513" y="124.2451">e.g.: Google</text><rect fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" height="62.8906" style="stroke:#A80036;stroke-width:1.5;" width="133" x="490.5" y="1139.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="497.5" y="1159.0029">OpenId-Connect</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="523" y="1175.2998">Authority</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="513" y="1191.5967">e.g.: Google</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="637.5" y="136.2451">Coffee Chat DB</text><path d="M678.5,87.25 C678.5,77.25 696.5,77.25 696.5,77.25 C696.5,77.25 714.5,77.25 714.5,87.25 L714.5,113.25 C714.5,123.25 696.5,123.25 696.5,123.25 C696.5,123.25 678.5,123.25 678.5,113.25 L678.5,87.25 " fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" style="stroke:#000000;stroke-width:1.5;"/><path d="M678.5,87.25 C678.5,97.25 696.5,97.25 696.5,97.25 C696.5,97.25 714.5,97.25 714.5,87.25 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="637.5" y="1152.0029">Coffee Chat DB</text><path d="M678.5,1165.3047 C678.5,1155.3047 696.5,1155.3047 696.5,1155.3047 C696.5,1155.3047 714.5,1155.3047 714.5,1165.3047 L714.5,1191.3047 C714.5,1201.3047 696.5,1201.3047 696.5,1201.3047 C696.5,1201.3047 678.5,1201.3047 678.5,1191.3047 L678.5,1165.3047 " fill="#FEFECE" filter="url(#f9f1yyur7i8nb)" style="stroke:#000000;stroke-width:1.5;"/><path d="M678.5,1165.3047 C678.5,1175.3047 696.5,1175.3047 696.5,1175.3047 C696.5,1175.3047 714.5,1175.3047 714.5,1165.3047 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="107.0078" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="170.6797"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="143.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="454.4844"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="171.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="706.4141"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="98.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="375" y="743.5469"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="171.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="370" y="950.3438"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="40.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="375" y="987.4766"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="330.9531"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="36.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="389.2188"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554" y="483.6172"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="691.5" y="777.6797"/><rect fill="#FFFFFF" filter="url(#f9f1yyur7i8nb)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="691.5" y="1063.7422"/><polygon fill="#A80036" points="358,166.6797,368,170.6797,358,174.6797,362,170.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="364" y1="170.6797" y2="170.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="113" y="165.6138">login</text><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="760.5" x="0" y="199.2461"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="199.2461" y2="199.2461"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="202.2461" y2="202.2461"/><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="170" x="295.25" y="188.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="151" x="301.25" y="204.7466">authentication flow</text><path d="M10,228.8125 L230,228.8125 L230,235.8125 L220,245.8125 L10,245.8125 L10,228.8125 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="291.9375" style="stroke:#000000;stroke-width:2.0;" width="637.5" x="10" y="228.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="25" y="241.8794">OpenId/Oauth 2.0 flow</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="278" x="245" y="241.0229">[this is the standard Oauth 2.0 challenge,</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="177" x="245" y="253.8276">abstracted by passport.js]</text><polygon fill="#A80036" points="117,273.6875,107,277.6875,117,281.6875,113,277.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="374" y1="277.6875" y2="277.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="123" y="272.6216">OpendId-Connect redirect</text><path d="M20,292.6875 L259,292.6875 L259,299.6875 L249,309.6875 L20,309.6875 L20,292.6875 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="104.5313" style="stroke:#000000;stroke-width:2.0;" width="617.5" x="20" y="292.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="189" x="35" y="305.7544">Authority login challenge</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="100" x="274" y="304.8979">[including MFA]</text><polygon fill="#A80036" points="542,326.9531,552,330.9531,542,334.9531,546,330.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="548" y1="330.9531" y2="330.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="113" y="325.8872">navigate to redirect</text><polygon fill="#A80036" points="117,356.0859,107,360.0859,117,364.0859,113,360.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="558" y1="360.0859" y2="360.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="123" y="355.02">Login Challenge</text><polygon fill="#A80036" points="542,385.2188,552,389.2188,542,393.2188,546,389.2188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="548" y1="389.2188" y2="389.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="113" y="384.1528">Answer login challenge</text><polygon fill="#A80036" points="117,421.3516,107,425.3516,117,429.3516,113,425.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="558" y1="425.3516" y2="425.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="123" y="420.2856">redirect to CoffeChat</text><polygon fill="#A80036" points="358,450.4844,368,454.4844,358,458.4844,362,454.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="364" y1="454.4844" y2="454.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="113" y="449.4185">navigate to redirected url</text><polygon fill="#A80036" points="542,479.6172,552,483.6172,542,487.6172,546,483.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="380" x2="548" y1="483.6172" y2="483.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="387" y="478.5513">get user profile</text><polygon fill="#A80036" points="391,508.75,381,512.75,391,516.75,387,512.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385" x2="558" y1="512.75" y2="512.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="397" y="507.6841">user profile</text><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="760.5" x="0" y="548.3164"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="548.3164" y2="548.3164"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="551.3164" y2="551.3164"/><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="340" x="210.25" y="537.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="321" x="216.25" y="553.8169">User authenticated / identified succesfully</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="380" x2="422" y1="597.0156" y2="597.0156"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="422" x2="422" y1="597.0156" y2="610.0156"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="375" x2="422" y1="610.0156" y2="610.0156"/><polygon fill="#A80036" points="385,606.0156,375,610.0156,385,614.0156,381,610.0156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="387" y="591.9497">create session in cookies</text><polygon fill="#A80036" points="117,630.1484,107,634.1484,117,638.1484,113,634.1484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="374" y1="634.1484" y2="634.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="123" y="629.0825">redirect and include session in cookies</text><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="760.5" x="0" y="662.7148"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="662.7148" y2="662.7148"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="665.7148" y2="665.7148"/><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="226" x="267.25" y="652.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="207" x="273.25" y="668.2153">User has session in cookies</text><polygon fill="#A80036" points="358,702.4141,368,706.4141,358,710.4141,362,706.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="364" y1="706.4141" y2="706.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="113" y="701.3481">get /jwt (include session cookies)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="380" x2="427" y1="730.5469" y2="730.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="427" x2="427" y1="730.5469" y2="743.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="386" x2="427" y1="743.5469" y2="743.5469"/><polygon fill="#A80036" points="396,739.5469,386,743.5469,396,747.5469,392,743.5469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="392" y="725.481">read user from session</text><polygon fill="#A80036" points="679.5,773.6797,689.5,777.6797,679.5,781.6797,683.5,777.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="385" x2="685.5" y1="777.6797" y2="777.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="392" y="772.6138">get or create user</text><polygon fill="#A80036" points="396,802.8125,386,806.8125,396,810.8125,392,806.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="390" x2="695.5" y1="806.8125" y2="806.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="402" y="801.7466">user found or created</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385" x2="427" y1="840.9453" y2="840.9453"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="427" x2="427" y1="840.9453" y2="853.9453"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="380" x2="427" y1="853.9453" y2="853.9453"/><polygon fill="#A80036" points="390,849.9453,380,853.9453,390,857.9453,386,853.9453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="392" y="835.8794">sign jwt</text><polygon fill="#A80036" points="117,874.0781,107,878.0781,117,882.0781,113,878.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="374" y1="878.0781" y2="878.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="19" x="123" y="873.0122">jwt</text><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="760.5" x="0" y="906.6445"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="906.6445" y2="906.6445"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="760.5" y1="909.6445" y2="909.6445"/><rect fill="#EEEEEE" filter="url(#f9f1yyur7i8nb)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="119" x="320.75" y="896.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="100" x="326.75" y="912.145">User has JWT</text><polygon fill="#A80036" points="358,946.3438,368,950.3438,358,954.3438,362,950.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="364" y1="950.3438" y2="950.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="113" y="945.2778">GQL with Bearer JWT</text><line style="stroke:#A80036;stroke-width:1.0;" x1="380" x2="427" y1="974.4766" y2="974.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="427" x2="427" y1="974.4766" y2="987.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="386" x2="427" y1="987.4766" y2="987.4766"/><polygon fill="#A80036" points="396,983.4766,386,987.4766,396,991.4766,392,987.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="392" y="969.4106">validate JWT and roles</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385" x2="427" y1="1026.6094" y2="1026.6094"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="427" x2="427" y1="1026.6094" y2="1039.6094"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="380" x2="427" y1="1039.6094" y2="1039.6094"/><polygon fill="#A80036" points="390,1035.6094,380,1039.6094,390,1043.6094,386,1039.6094" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="392" y="1021.5435">valid JWT</text><polygon fill="#A80036" points="679.5,1059.7422,689.5,1063.7422,679.5,1067.7422,683.5,1063.7422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="380" x2="685.5" y1="1063.7422" y2="1063.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="387" y="1058.6763">some DB op</text><polygon fill="#A80036" points="391,1088.875,381,1092.875,391,1096.875,387,1092.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385" x2="695.5" y1="1092.875" y2="1092.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="397" y="1087.8091">data</text><polygon fill="#A80036" points="117,1118.0078,107,1122.0078,117,1126.0078,113,1122.0078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="111" x2="374" y1="1122.0078" y2="1122.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="123" y="1116.9419">data</text><!--MD5=[7a6305611130989e0959cb26988bb1a3]
@startuml
autoactivate on

title JWT Authority sequence diagram 

actor "User\nactually the browser" as User
participant "Coffee Chat" as CoffeeChat
participant "OpenId-Connect\nAuthority\ne.g.: Google" as OpenIdConnectAuthority
database "Coffee Chat DB" as CoffeeChatDB

User -> CoffeeChat: login

== authentication flow ==

group OpenId/Oauth 2.0 flow [this is the standard Oauth 2.0 challenge,\nabstracted by passport.js]
  CoffeeChat - -> User:  OpendId-Connect redirect
  group Authority login challenge [including MFA]
    User -> OpenIdConnectAuthority: navigate to redirect
    OpenIdConnectAuthority - -> User: Login Challenge
    User -> OpenIdConnectAuthority: Answer login challenge
  end
  OpenIdConnectAuthority - -> User: redirect to CoffeChat
  User -> CoffeeChat: navigate to redirected url
  CoffeeChat -> OpenIdConnectAuthority: get user profile
  OpenIdConnectAuthority - -> CoffeeChat: user profile
end

== User authenticated / identified succesfully ==

CoffeeChat - -> CoffeeChat: create session in cookies
CoffeeChat - -> User: redirect and include session in cookies

== User has session in cookies ==

User -> CoffeeChat: get /jwt (include session cookies)

CoffeeChat-> CoffeeChat: read user from session
CoffeeChat -> CoffeeChatDB: get or create user
CoffeeChatDB - -> CoffeeChat: user found or created
CoffeeChat - -> CoffeeChat: sign jwt
CoffeeChat - -> User: jwt

== User has JWT ==

User -> CoffeeChat: GQL with Bearer JWT
CoffeeChat -> CoffeeChat: validate JWT and roles
CoffeeChat - -> CoffeeChat: valid JWT
CoffeeChat -> CoffeeChatDB: some DB op
CoffeeChatDB - -> CoffeeChat: data
CoffeeChat - -> User: data
@enduml

PlantUML version 1.2021.10(Mon Aug 30 13:43:48 UTC 2021)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>